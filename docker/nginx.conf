events {}

http {
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  server {
    listen 8080;

    # Forward WebSocket proxy traffic to the ws proxy on 1338
    location /service/proxy/ {
      # Strip the /service/proxy/ prefix so wsproxy sees /u/<host:port>
      rewrite ^/service/proxy/(.*)$ /$1 break;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Origin $http_origin;
      proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;
      proxy_set_header Sec-WebSocket-Extensions $http_sec_websocket_extensions;
      proxy_set_header Sec-WebSocket-Version $http_sec_websocket_version;
      proxy_set_header Sec-WebSocket-Key $http_sec_websocket_key;
      proxy_pass_header Sec-WebSocket-Protocol;
      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
      proxy_buffering off;
      proxy_redirect off;
      proxy_pass http://game:1338;
    }

    # Forward WebSocket proxy traffic to the ws proxy on 1338
    location ~ ^/ws/?$ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_read_timeout 60s;
      proxy_send_timeout 60s;
      proxy_buffering off;
      proxy_redirect off;
      proxy_pass http://game:1337;
    }

    # Forward all other web traffic to the game server on 1337
    location / {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://game:1337;
    }
  }
}
