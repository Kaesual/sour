#!/usr/bin/env bash

set -euo pipefail

source "$(dirname "$0")/buildenv-vars"

$CONTAINER_CMD run \
  --rm \
  --user "$HOST_UID:$HOST_GID" \
  --env-file "$PROJECT_ROOT/docker/common.env" \
  -e ASSET_OUTPUT_DIR="$ASSET_OUTPUT_DIR" \
  -e ASSET_CACHE_DIR="$ASSET_CACHE_DIR" \
  -v "$PROJECT_ROOT":/workspace \
  -w /workspace/assets \
  "$IMAGE_TAG" \
  bash -lc '
    set -e
    rm -rf /workspace/assets/output || true
    mkdir -p "$HOME" "$PIP_CACHE_DIR"
    python3 -m pip install --user -r requirements.txt || true
    mkdir -p "$ASSET_CACHE_DIR"
    ./setup-quad
    # OPTIONAL: Rebuild sourdump to ensure latest code is used
    # rm -f sourdump
    # go build -o sourdump ../cmd/sourdump/main.go
    # Build quadropolis assets
    python3 quadropolis.py \
      --prefix $(git rev-parse --short HEAD 2>/dev/null || echo "dev")
  '

echo "Successfully built quadropolis assets"
