#!/usr/bin/env bash

set -euo pipefail

IMAGE_TAG="sour-emscripten:3.1.8"
PROJECT_ROOT="$(cd "$(dirname "$0")"/.. && pwd)"

HOST_UID="$(id -u)"
HOST_GID="$(id -g)"

exec docker run --rm \
  --user "$HOST_UID:$HOST_GID" \
  --env-file "$PROJECT_ROOT/docker/common.env" \
  -v "$PROJECT_ROOT":/workspace \
  -w /workspace/proxy \
  "$IMAGE_TAG" \
  bash -lc '
    set -e
    make clean || true
    make
    echo "Built proxy: /workspace/proxy/wsproxy"
  '


