#!/usr/bin/env bash

set -euo pipefail

CONTAINER_ENGINE=${CONTAINER_ENGINE:-}
if [ -z "${CONTAINER_ENGINE}" ]; then
  if command -v docker >/dev/null 2>&1; then
    CONTAINER_ENGINE=docker
  elif command -v podman >/dev/null 2>&1; then
    CONTAINER_ENGINE=podman
  else
    echo "Neither docker nor podman found. Please install one or set CONTAINER_ENGINE."
    exit 1
  fi
fi

IMAGE_TAG="sour-emscripten:3.1.8"
PROJECT_ROOT="$(cd "$(dirname "$0")"/.. && pwd)"
EM_CACHE_DIR="$PROJECT_ROOT/.emscripten-cache"

# Allow overriding output dir
GAME_OUTPUT_DIR=${GAME_OUTPUT_DIR:-dist/game}

# Run as the host user to avoid root-owned files; mount a writable EM_CACHE
HOST_UID="$(id -u)"
HOST_GID="$(id -g)"
mkdir -p "$EM_CACHE_DIR"

exec "$CONTAINER_ENGINE" run --rm \
  --user "$HOST_UID:$HOST_GID" \
  --env-file "$PROJECT_ROOT/docker/common.env" \
  -e GAME_OUTPUT_DIR="$GAME_OUTPUT_DIR" \
  -v "$PROJECT_ROOT":/workspace \
  -w /workspace/game \
  "$IMAGE_TAG" \
  bash -lc '
    set -e
    source /emsdk/emsdk_env.sh

    echo "[1/1] Building WASM game..."
    cd /workspace/game
    ./build
  '
